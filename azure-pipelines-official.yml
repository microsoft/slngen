resources:
- repo: self

variables:
  BuildConfiguration: 'Debug'
  BuildPlatform: 'Any CPU'
  DotNetCore3Version: '3.1.100'
  SignType: 'Test'

trigger:
  batch: true
  branches:
    include:
    - 'master'
    - 'refs/tags/*'
  paths:
    exclude:
    - '*.md'

pr: none

jobs:
- job: BuildAndTest
  displayName: 'Build and Test'
  pool:
    name: VSEng-MicroBuildVS2019
  steps:
  - task: UseDotNet@2
    displayName: 'Install .NET Core 3.1'
    inputs:
      version: '$(DotNetCore3Version)'

  - script: 'echo ##vso[task.setvariable variable=SignType;]Real'
    displayName: 'Set SignType to Real for tagged commits'
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))

  - task: ms-vseng.MicroBuildTasks.30666190-6959-11e5-9f96-f56098202fef.MicroBuildSigningPlugin@1
    displayName: 'Install Signing Plugin'
    inputs:
      signType: '$(SignType)'
      zipSources: false

  - task: MSBuild@1
    displayName: 'Build Solution'
    inputs:
      solution: SlnGen.sln
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
      msbuildArguments: '"/BinaryLogger:logs\msbuild.binlog"'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: Logs'
    inputs:
      PathtoPublish: 'logs'
      ArtifactName: Logs
    condition: failed()

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Artifact: Artifacts'
    inputs:
      artifactName: 'Artifacts'
      targetPath: 'artifacts'

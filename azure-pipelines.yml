resources:
- repo: self

variables:
  ArtifactsDirectoryName: 'artifacts'
  BinaryLoggerArgs: '"/BinaryLogger:$(Build.SourcesDirectory)\$(ArtifactsDirectoryName)\msbuild.binlog"'
  DotNetCore3Version: '3.x'
  DotNetCore5Version: '5.x'
  SignType: 'Test'

trigger:
  batch: true
  branches:
    include:
    - 'master'
    - 'rel/*'
  paths:
    exclude:
    - '*.md'
pr:
  branches:
    include:
    - master
    - 'rel/*'
  paths:
    exclude:
    - '*.md'

jobs:
- job: BuildAndTest
  displayName: 'Build and Test'
  pool:
    vmImage: windows-latest
  steps:
  - task: UseDotNet@2
    displayName: 'Install .NET Core $(DotNetCore3Version)'
    inputs:
      version: '$(DotNetCore3Version)'
      includePreviewVersions: true

  - task: UseDotNet@2
    displayName: 'Install .NET Core $(DotNetCore5Version)'
    inputs:
      version: '$(DotNetCore5Version)'
      includePreviewVersions: true

  - task: DotNetCoreCLI@2
    displayName: 'Build Solution'
    inputs:
      command: 'build'
      projects: 'SlnGen.sln'
      arguments: '"/p:SignType=Test" $(BinaryLoggerArgs)'

  - task: DotNetCoreCLI@2
    displayName: 'Run Unit Tests'
    inputs:
      command: 'test'
      arguments: '--no-restore --no-build "/restore:false"'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts'
    inputs:
      PathtoPublish: '$(ArtifactsDirectoryName)'
      ArtifactName: $(ArtifactsDirectoryName)
    condition: always()